require 'bundler/setup'
require 'minitest/autorun'
require 'minitest/unit'
require 'mocha/mini_test'
require 'webmock/minitest'
require 'active_support'
require 'rails/generators'
require 'rails/generators/test_case'
require 'generators/transbank_oneclick/install/install_generator'
require 'transbank-oneclick'

require "minitest/reporters"
Minitest::Reporters.use! [Minitest::Reporters::DefaultReporter.new(color: true)]

INIT_INSCRIPTION_XML = %q{<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"><SOAP-ENV:Header><wsse:Security xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd" SOAP-ENV:mustUnderstand="1"><ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"></ds:CanonicalizationMethod><ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"></ds:SignatureMethod><ds:Reference URI="#dge763trgad"><ds:Transforms><ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"></ds:DigestMethod><ds:DigestValue>0BrXmTm2mc2ZRtl/MItcP95fKRg=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>sMXYD7Y5UiuBqHcZNAQYASx4pS0iv2szapjCIlAxyj/VLGfyuHHiKeIannYxcdE4FSL7ubOyKTDW46m3F4xvimYqBAxT6XmoWIpRTohsUL0yVcXlcd3tsyw34ik0+ESDtWxsfYEVoYktW5IceIb3ZcZyCCInvy0ef7aQxFR0tluejqFF9w2TtLcqgwdTDR2n/Xb2sRr+Propdc2rgSElWvz/EYA4yquAKQP/Lw+9+7u6twEM0o6axY+ZQq2VG8ydUjazoZ/25GyPGibQ7OmJ0FnisqpkLDMbgkSJcNcTlpqFTM9Ces0SEx1aTGMiSvP8/Kes0ceWgQgyvCoE/2vDKw==</ds:SignatureValue><ds:KeyInfo><wsse:SecurityTokenReference><ds:X509Data><ds:X509IssuerSerial><ds:X509IssuerName>C=CL,ST=Some-State,L=SANTIAGO,O=Internet Widgits Pty Ltd,CN=597029124456</ds:X509IssuerName><ds:X509SerialNumber>18335542990572456259</ds:X509SerialNumber></ds:X509IssuerSerial></ds:X509Data></wsse:SecurityTokenReference></ds:KeyInfo></ds:Signature></wsse:Security></SOAP-ENV:Header><SOAP-ENV:Body xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" wsu:Id="dge763trgad"><ns1:init_inscription xmlns:ns1="http://webservices.webpayserver.transbank.com/"><arg0><email>username@domain</email><username>username</username><response_url>http://domain/card</response_url></arg0></ns1:init_inscription></SOAP-ENV:Body></SOAP-ENV:Envelope>}
FINISH_INSCRIPTION_XML = %q{<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"><SOAP-ENV:Header><wsse:Security xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd" SOAP-ENV:mustUnderstand="1"><ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"></ds:CanonicalizationMethod><ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"></ds:SignatureMethod><ds:Reference URI="#dge763trgad"><ds:Transforms><ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"></ds:DigestMethod><ds:DigestValue>IHwQM0OmsM6YCyFNI1kG5RdMtk4=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>AGO75Nn0u5YrmRaLeN055X1WBj1Ikzb1sgP4chOsMNTQDmG7fAW/FTE7ldTzHNmHolrLD2Scmb2H7Xu9k3OqfjGTM0883zyKLXZiyNPBqpW2CqiTcb+i1O490BVZcsRMVWd8P/EGoWpcuLwDYlq0j1Ym6486OZ0V0+E9Rj5U4tc3ShjHd7rJRiO2J8+rq9CmUhn++Yd+v+LGDev54UQHFp574CmWPC3s5u7JXJ1Bf2zZN4jZR1LGvtDDRWw+CRmm/k9XNpgw57+9bJQYN7xwg248vztvCX/mtPqwayNiqhXwo3cAKgCFP6WoK0XNTWWqxUVRrf6fNSxc8JqWPKBGoA==</ds:SignatureValue><ds:KeyInfo><wsse:SecurityTokenReference><ds:X509Data><ds:X509IssuerSerial><ds:X509IssuerName>C=CL,ST=Some-State,L=SANTIAGO,O=Internet Widgits Pty Ltd,CN=597029124456</ds:X509IssuerName><ds:X509SerialNumber>18335542990572456259</ds:X509SerialNumber></ds:X509IssuerSerial></ds:X509Data></wsse:SecurityTokenReference></ds:KeyInfo></ds:Signature></wsse:Security></SOAP-ENV:Header><SOAP-ENV:Body xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" wsu:Id="dge763trgad"><ns1:finish_inscription xmlns:ns1="http://webservices.webpayserver.transbank.com/"><arg0><token>fyegwyufgi3289rheowifewfiasocgh2e78c</token></arg0></ns1:finish_inscription></SOAP-ENV:Body></SOAP-ENV:Envelope>}
AUTHORIZE_XML = %q{<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"><SOAP-ENV:Header><wsse:Security xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd" SOAP-ENV:mustUnderstand="1"><ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"></ds:CanonicalizationMethod><ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"></ds:SignatureMethod><ds:Reference URI="#dge763trgad"><ds:Transforms><ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"></ds:DigestMethod><ds:DigestValue>5Cly+K17xLkr7oiICa7phcdvbos=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>m7UKJYImHNr0jWN3dOqfXmOXzqNQ4UZ4wII6R/XwtZmJp1dLV71WXvABBP35mTIgKD1Bd3FbDXxrPndVw/FjliotujOBGeUk+qJKGLhm+uET1Mr5acNPtmQE2Kw7Ls4qrWkqbyIEOv8skJfnhy6qZeJgmHsgjPqARW3QTUPSfqL2Z3ysNqriRw92c8ZrKF518e/B/f1ua8ruaIz4srEcMD+4RVE0DP4ao/iNHJA5rVB4mbb9JW2Hb+isyDjCXCfZzx5K2szJksBV/BagFdF7+No44bpH37tL6H3jHw1hAkWjST/1WN1RC+1IflQIZUVBQh0IXw+AmjDQ/AceYqef7A==</ds:SignatureValue><ds:KeyInfo><wsse:SecurityTokenReference><ds:X509Data><ds:X509IssuerSerial><ds:X509IssuerName>C=CL,ST=Some-State,L=SANTIAGO,O=Internet Widgits Pty Ltd,CN=597029124456</ds:X509IssuerName><ds:X509SerialNumber>18335542990572456259</ds:X509SerialNumber></ds:X509IssuerSerial></ds:X509Data></wsse:SecurityTokenReference></ds:KeyInfo></ds:Signature></wsse:Security></SOAP-ENV:Header><SOAP-ENV:Body xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" wsu:Id="dge763trgad"><ns1:authorize xmlns:ns1="http://webservices.webpayserver.transbank.com/"><arg0><amount>99999</amount><tbk_user>35700491-cb03-4bbb-8ab7-29dd7b0771ab</tbk_user><username>user_1</username><buy_order>20110715115550003</buy_order></arg0></ns1:authorize></SOAP-ENV:Body></SOAP-ENV:Envelope>}
REVERSE_XML = %q{<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"><SOAP-ENV:Header><wsse:Security xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd" SOAP-ENV:mustUnderstand="1"><ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"></ds:CanonicalizationMethod><ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"></ds:SignatureMethod><ds:Reference URI="#dge763trgad"><ds:Transforms><ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"></ds:DigestMethod><ds:DigestValue>9B2Jhrmw13cLqSMKfCGj3XU3W8k=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>Mr3W82xULZwHOCuwperpcJNJUEJMH7nMoiDeDE9JeSz9CSIDyUTz/fWhe5nCIzTuzx8JpYSgPiqbPv4WYkKuPOcZeWnhE3v6ewL/xw732XpBkwlFgA1zRPi9tI+y3YgPbPxuklvbHuMgq771YKwJAM5tN6xHyd1Oj2wiOXAw/DA6j5vpch74ruHiucbI3UB4FMOpTTagQlcvBvz+a9ZP27cJ2V/3PYNd6Bz12bcdUhm5GvORGdqVRC0KB0vA11E4lCjXzzjZenf/4KHE6Zh7gYboUNstDrinQZkF7XnUn8mw4qjP7gi8jkzoJS3jPW9Ctkx2RrxG/eMUJ4NsY73jNA==</ds:SignatureValue><ds:KeyInfo><wsse:SecurityTokenReference><ds:X509Data><ds:X509IssuerSerial><ds:X509IssuerName>C=CL,ST=Some-State,L=SANTIAGO,O=Internet Widgits Pty Ltd,CN=597029124456</ds:X509IssuerName><ds:X509SerialNumber>18335542990572456259</ds:X509SerialNumber></ds:X509IssuerSerial></ds:X509Data></wsse:SecurityTokenReference></ds:KeyInfo></ds:Signature></wsse:Security></SOAP-ENV:Header><SOAP-ENV:Body xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" wsu:Id="dge763trgad"><ns1:code_reverse_one_click xmlns:ns1="http://webservices.webpayserver.transbank.com/"><arg0><buy_order>20110715115550003</buy_order></arg0></ns1:code_reverse_one_click></SOAP-ENV:Body></SOAP-ENV:Envelope>}
REMOVE_USER_XML = %q{<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"><SOAP-ENV:Header><wsse:Security xmlns:wsse="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd" SOAP-ENV:mustUnderstand="1"><ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"></ds:CanonicalizationMethod><ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"></ds:SignatureMethod><ds:Reference URI="#dge763trgad"><ds:Transforms><ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"></ds:Transform></ds:Transforms><ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"></ds:DigestMethod><ds:DigestValue>ky84GGpUNWifeLGMvHARCkYnH/A=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>uA/FBTbofW1GHUU6wjldJ0WShUARW6zLxQMUiXXwKWb+BoTvDDB7Hk6cRb5iC0n+LjqWAKuoTkyT/6CYFDWNOP7s0Cb/TrPI/Qw9gTTF1UCA3wWLaDwwMfDNyniWtIwfM9sTwrsh7sRL9qtEetjZVR/CejUePLTLtkQSdNnTO23mKUhBlyWQav2MwuYJntVB8LghdqFyvFo/IncA9cF6wmhBVqJvCvma7+Kn9kQjmgRCzxGGej75lJ4/GG5tgk6TJUxtwRzV73uk3bB/nZGjnOIB4qvrCgU0NPoaUkn3/k1JBPE4BmKmBo36/JRn1dj9JNJG65KSeHktNhDOjVryow==</ds:SignatureValue><ds:KeyInfo><wsse:SecurityTokenReference><ds:X509Data><ds:X509IssuerSerial><ds:X509IssuerName>C=CL,ST=Some-State,L=SANTIAGO,O=Internet Widgits Pty Ltd,CN=597029124456</ds:X509IssuerName><ds:X509SerialNumber>18335542990572456259</ds:X509SerialNumber></ds:X509IssuerSerial></ds:X509Data></wsse:SecurityTokenReference></ds:KeyInfo></ds:Signature></wsse:Security></SOAP-ENV:Header><SOAP-ENV:Body xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" wsu:Id="dge763trgad"><ns1:remove_user xmlns:ns1="http://webservices.webpayserver.transbank.com/"><arg0><tbk_user>35700491-cb03-4bbb-8ab7-29dd7b0771ab</tbk_user><username>user_1</username></arg0></ns1:remove_user></SOAP-ENV:Body></SOAP-ENV:Envelope>}

ActiveSupport.test_order = :sorted

Transbank::Oneclick.configure do |config|
  config.url       = 'https://transbank-example.cl/oneclick'
  config.cert_path = 'spec/keys/597029124456.crt'
  config.key_path  = 'spec/keys/597029124456.key'
  config.server_cert_path = 'spec/keys/server/server_tbk.crt'
end